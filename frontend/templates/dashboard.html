<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatsApp</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/dashboard.css">
    <!-- Добавляем библиотеку Emoji Picker -->
    <style>
        .message-input-area {
            position: relative;
        }

        .message-input {
            position: relative;
            display: flex;
            align-items: center;
        }

        .icon-left, .icon-right {
            cursor: pointer;
        }

        .emoji-popup {
            position: absolute;
            background: #2a3e4c;
            border: 1px solid #4a6b66;
            padding: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            bottom: 50px;
            left: 0;
            z-index: 100;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-width: 200px;
        }

        .emoji-popup.hidden {
            display: none;
        }

        .emoji {
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
            color: white;
        }

        .emoji:hover {
            background-color: #3e5c76;
        }
        .message-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            min-height: 0;
        }

        .message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            max-width: 70%;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message.sent {
            justify-content: flex-end;
            margin-left: auto;
        }

        .message .avatar {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            margin-right: 10px;
            flex-shrink: 0;
            overflow: hidden !important;
        }

        .message.received .avatar {
            margin-right: 10px;
        }

        .message.sent .avatar {
            margin-left: 10px;
            order: 2;
        }

        .message .avatar img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            border-radius: 50% !important;
        }

        .message-content {
            display: flex;
            flex-direction: column;
        }

        .message.received .message-content {
            background-color: #1F392D;
            color: white;
            border-radius: 5px;
            padding: 8px 12px;
        }

        .message.sent .message-content {
            background-color: #48926F;
            color: white;
            border-radius: 10px;
            padding: 8px 12px;
        }

        .message-sender {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .message-text {
            font-size: 14px;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 12px;
            color: #b0b0b0;
            margin-top: 4px;
            text-align: right;
        }

        .date-divider {
            text-align: center;
            margin: 10px 0;
            color: white;
            font-size: 20px;
            position: relative;
        }

        .date-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #b0b0b0;
            z-index: -1;
        }

        .date-divider span {
            background: #48926F;
            border-radius: 10px;
            padding: 0 20px;
        }

        .error {
            color: red;
            text-align: center;
        }

        .contact-item.group {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .chat-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-actions .action-icon {
            cursor: pointer;
        }

        .dropdown-menu {
            position: absolute;
            top: 40px;
            right: 10px;
            background-color: #1F392D;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }

        .dropdown-menu.active {
            display: block;
        }

        .dropdown-item {
            padding: 10px 15px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background-color: #48926F;
        }

        .message-context-menu {
            position: absolute;
            background-color: #1F392D;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }

        .message-context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 10px 15px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        .context-menu-item:hover {
            background-color: #48926F;
        }

        /* Стили для изображений и Emoji Picker */
        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 5px;
            margin-top: 5px;
        }

        /* emoji-picker {
            position: absolute;
            bottom: 60px;
            left: 20px;
            z-index: 1000;
            width: 300px;
            height: 400px;
            background-color: #1F392D;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        } */

        .message-input {
            position: relative;
        }

        .icon-left,
        .icon-right {
            cursor: pointer;
        }

        .edit-input {
            background-color: #fff;
            color: #000;
            font-size: 14px;
            outline: none;
        }

        .message-text.translated {
            cursor: pointer;
            font-style: italic;
        }
        .message-text.translated:hover {
            text-decoration: underline;
        }



        /* // Add this CSS to your existing <style> block in the HTML */
            .message.received:hover .translate-icon {
            display: block;
            padding: 10px;
        }

        .translate-icon {
            display: none;
            position: absolute;
            /* right: 600px; */
            top: 70%;
            transform: translateY(-50%);
            color: white;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            background-color: #3e5c76;
            border-radius: 50%;
        }

        .translate-icon:hover {
            background-color: #48926F;
        }












    </style>
</head>

<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="search-container">
                <div class="search-bar">
                    <i>
                        <svg width="20" height="20" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M0 11.2511C0 17.464 5.05263 22.5005 11.3684 22.5005C13.8947 22.5005 16.2406 21.6204 18.2256 20.1422C18.2256 20.294 18.406 20.4349 18.406 20.5614L27.4286 29.5609C27.9699 30.1464 29.0526 30.1464 29.594 29.5609C30.1353 28.9754 30.1353 28.0248 29.594 27.4393L20.5714 18.4399C20.391 18.3134 20.391 18.2158 20.2105 18.1435C21.6541 16.2388 22.5564 13.848 22.5564 11.2511C22.5564 5.03644 17.5038 0 11.3684 0C5.05263 0 0 5.03644 0 11.2511ZM3.06836 11.2511C3.06836 6.69354 6.67738 2.99979 11.3691 2.99979C15.8804 2.99979 19.4894 6.69354 19.4894 11.2511C19.4894 15.8069 15.8804 19.5006 11.3691 19.5006C6.67738 19.5006 3.06836 15.8069 3.06836 11.2511Z"
                                fill="white" />
                        </svg>
                    </i>
                    <input type="search" placeholder="Search" id="search-input">
                </div>
                <div class="search-menu-icon">
                    <i>
                        <svg width="40" height="40" viewBox="0 0 50 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M25.0002 20C27.2918 20 29.1668 17.75 29.1668 15C29.1668 12.25 27.2918 10 25.0002 10C22.7085 10 20.8335 12.25 20.8335 15C20.8335 17.75 22.7085 20 25.0002 20ZM25.0002 25C22.7085 25 20.8335 27.25 20.8335 30C20.8335 32.75 22.7085 35 25.0002 35C27.2918 35 29.1668 32.75 29.1668 30C29.1668 27.25 27.2918 25 25.0002 25ZM25.0002 40C22.7085 40 20.8335 42.25 20.8335 45C20.8335 47.75 22.7085 50 25.0002 50C27.2918 50 29.1668 47.75 29.1668 45C29.1668 42.25 27.2918 40 25.0002 40Z"
                                fill="white" />
                        </svg>
                    </i>
                </div>
            </div>
            <div class="contact-list" id="contact-list">
                {% if contacts %}
                {% for contact in contacts %}
                {% set room, user, last_msg_content, sender_username = contact %}
                {% set contact_obj = contact_data_dict.get(user.id) if user else None %}
                <div class="contact-item {% if room and room.type == 'group' %}group{% endif %} {% if selected_contact and user and selected_contact[1] and selected_contact[1].id == user.id %}selected{% endif %}"
                    data-contact-id="{{ user.id if user else '' }}" data-room-id="{{ room.id if room else '' }}"
                    data-username="{{ user.username if user else room.name if room else '' }}"
                    data-room-type="{{ room.type if room else 'private' }}"
                    data-avatar="{% if contact_obj and contact_obj.avatar_data %}data:image/png;base64,{{ contact_obj.avatar_data | b64encode }}{% else %}default{% endif %}">
                    <div class="contact-avatar">
                        {% if room and room.type == 'group' %}
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"
                            fill="currentColor" class="contact-avatar-icon">
                            <path
                                d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                        </svg>
                        {% else %}
                        {% if contact_obj and contact_obj.avatar_data %}
                        <img src="data:image/png;base64,{{ contact_obj.avatar_data | b64encode }}" alt="avatar"
                            class="contact-avatar-img" width="50" height="50">
                        {% else %}
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"
                            fill="currentColor" class="contact-avatar-icon">
                            <path
                                d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                        </svg>
                        {% endif %}
                        {% endif %}
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">{{ user.username if user else room.name if room else '' }}</div>
                        <!-- <div class="contact-last-msg">
                            {% if last_msg_content %}
                            {{ sender_username }}: {{ last_msg_content }}
                            {% else %}
                            —
                            {% endif %}
                        </div> -->
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="po-umol" style="color: white; padding: 8px 14px; font-size: 18;">У вас пока нет контактов.</p>
                {% endif %}
            </div>
            <div class="nav-icons">
                <div class="nav-item" id="nav-chats">
                    <div class="nav-circle">
                        <a href="/dash/"><i class="fas fa-comment-alt"></i></a>
                    </div>
                </div>
                <div class="nav-item" id="nav-status">
                    <div class="nav-circle">
                        <a href="/dash/status"><i class="fas fa-video"></i></a>
                    </div>
                </div>
                <div class="nav-item" id="nav-favorites">
                    <div class="nav-circle">
                        <a href="/dash/admin"><i class="fas fa-star"></i></a>
                    </div>
                </div>
                <div class="nav-item" id="nav-new">
                    <div class="nav-circle">
                        <a href="/dash/add_con"><i class="fas fa-user-plus"></i></a>
                    </div>
                </div>
                <div class="nav-item" id="nav-profile">
                    <div class="nav-circle">
                        <a href="/dash/profile"><i class="fas fa-user"></i></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="chat-area-con" id="chat-area-con"></div>
        <div class="chat-area" id="chat-area">
            <div class="chat-header">
                <div class="chat-back" id="chat-back">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <div class="chat-info" style="display: flex; align-items: center; gap: 10px;">
                    <div class="contact-avatar" style="margin-left: 20px;">
                        {% if selected_contact_user and selected_contact_user.avatar_data %}
                        <img src="data:image/png;base64,{{ selected_contact_user.avatar_data | b64encode }}"
                            alt="avatar" class="contact-avatar-img" width="50" height="50">
                        {% elif selected_contact_room and selected_contact_room.type == 'group' %}
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"
                            fill="currentColor" class="contact-avatar-icon">
                            <path
                                d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                        </svg>
                        {% else %}
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"
                            fill="currentColor" class="contact-avatar-icon">
                            <path
                                d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                        </svg>
                        {% endif %}
                    </div>
                    <div style="display: flex; flex-direction: column;">
                        <div class="chat-title" id="current-chat-title" style="font-weight: bold; color: white;">
                            {% if selected_contact %}
                            {{ selected_contact[1].username if selected_contact[1] else selected_contact[2].name }}
                            {% else %}
                            Выберите контакт
                            {% endif %}
                        </div>
                        <div id="chat-status" style="font-size: 12px; color: lightgray;"></div>
                    </div>
                </div>
                <div class="chat-actions">
                    <i class="fas fa-ellipsis-v action-icon" id="chat-menu" title="Меню"></i>
                    <div class="dropdown-menu" id="dropdown-menu">
                        <div class="dropdown-item" id="clear-chat">Очистить чат</div>
                    </div>
                </div>
            </div>
            <div class="message-list" id="message-list">
                <div class="loading">Select a chat to view messages</div>
            </div>
            <div class="message-input-area">
                <div class="message-input">
                    <i class="far fa-smile icon-left" id="emoji-toggle"></i>
                    <input type="text" id="message-input" placeholder="Enter the message">
                    <i class="fas fa-paperclip icon-right" id="attach-image"></i>
                </div>
                <div id="emoji-popup" class="emoji-popup hidden">
                    <span class="emoji">😀</span>
                    <span class="emoji">😁</span>
                    <span class="emoji">😂</span>
                    <span class="emoji">🤣</span>
                    <span class="emoji">😃</span>
                    <span class="emoji">😄</span>
                    <span class="emoji">😅</span>
                    <span class="emoji">😆</span>
                    <span class="emoji">😉</span>
                    <span class="emoji">😊</span>
                </div>
                <div class="actions">
                    <i class="fas fa-microphone" id="mic-icon" class="active"></i>
                    <i class="fas fa-paper-plane" id="send-icon"></i>
                </div>
                <!-- Добавляем скрытый input для загрузки изображений -->
                <input type="file" id="image-input" accept="image/*" style="display: none;">
                <!-- Панель Emoji Picker -->
                <emoji-picker id="emoji-picker" style="display: none;"></emoji-picker>
            </div>
            <div class="message-context-menu" id="message-context-menu">
                <div class="context-menu-item" id="delete-message">Удалить</div>
                <div class="context-menu-item" id="edit-message">Редоктировать</div>
                <div class="context-menu-item" id="translate-message">Перевести</div>

            </div>
        </div>
    </div>
    <script>
        const input = document.getElementById("message-input");
        const micIcon = document.getElementById("mic-icon");
        const sendIcon = document.getElementById("send-icon");
        const emojiButton = document.getElementById('emoji-toggle');
        const emojiPopup = document.getElementById('emoji-popup');
        const attachImage = document.getElementById("attach-image");
        const imageInput = document.getElementById("image-input");
        const userId = "{{ request.state.user_id }}";
        let currentRoomId = null;
        let chatSocket = null;
        let lastDate = null;


        // Close popup when clicking outside
        document.addEventListener('click', (e) => {
            if (!emojiPopup.contains(e.target) && !emojiButton.contains(e.target)) {
                emojiPopup.classList.add('hidden');
            }
        });

        // Обработчик загрузки изображения
        attachImage.addEventListener('click', () => {
            imageInput.click();
        });

        imageInput.addEventListener('change', () => {
            const file = imageInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64Image = reader.result; // base64 строка изображения
                    sendMessage(currentRoomId, input.value.trim(), base64Image);
                    input.value = ''; // Очищаем текстовое поле
                    imageInput.value = ''; // Очищаем input
                };
                reader.readAsDataURL(file);
            }
        });

        // Функция для получения токена
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                return parts.pop().split(';').shift();
            }
        }

        function getTokenFromIndexedDB() {
            const request = indexedDB.open('userKeysDB', 2);
            return new Promise((resolve, reject) => {
                request.onupgradeneeded = function (event) {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('tokens')) {
                        db.createObjectStore('tokens', { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = function (event) {
                    const db = event.target.result;
                    const transaction = db.transaction('tokens', 'readonly');
                    const store = transaction.objectStore('tokens');
                    const getRequest = store.get(1);
                    getRequest.onsuccess = function () {
                        if (getRequest.result) {
                            resolve(getRequest.result.token);
                        } else {
                            reject('Токен не найден в IndexedDB');
                        }
                    };
                    getRequest.onerror = function () {
                        reject('Ошибка при получении токена из IndexedDB');
                    };
                };
                request.onerror = function (event) {
                    reject(`Ошибка при открытии IndexedDB: ${event.target.error}`);
                };
            });
        }

        function getToken() {
            return new Promise((resolve, reject) => {
                let token = getCookie('access_token');
                console.log("Токен из cookies:", token);
                if (token) {
                    resolve(token);
                } else {
                    getTokenFromIndexedDB().then(fetchedToken => {
                        console.log("Токен из IndexedDB:", fetchedToken);
                        if (fetchedToken) {
                            resolve(fetchedToken);
                        } else {
                            reject('Токен не действителен');
                        }
                    }).catch(error => {
                        reject(error);
                    });
                }
            });
        }

        // Функция для форматирования даты
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
                return "Сегодня";
            }
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return "Вчера";
            }
            return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
        }

        // Функция для создания разделителя даты
        function createDateDivider(dateStr) {
            const divider = document.createElement('div');
            divider.classList.add('date-divider');
            divider.innerHTML = `<span>${dateStr}</span>`;
            return divider;
        }

        // Modify the createMessageElement function to add the translation icon for received messages
        function createMessageElement(msg, isSent) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(isSent ? 'sent' : 'received');
            messageDiv.setAttribute('data-message-id', msg.message_id || '');
            messageDiv.setAttribute('data-sender-id', msg.sender_id);

            // Avatar
            const avatarDiv = document.createElement('div');
            avatarDiv.classList.add('avatar');
            if (msg.avatar_data) {
                const img = document.createElement('img');
                img.src = `data:image/png;base64,${msg.avatar_data}`;
                img.alt = 'avatar';
                img.width = 40;
                img.height = 40;
                avatarDiv.appendChild(img);
            } else {
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('viewBox', '0 0 24 24');
                svg.setAttribute('width', '24');
                svg.setAttribute('height', '24');
                svg.setAttribute('fill', 'currentColor');
                svg.innerHTML = '<path d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>';
                avatarDiv.appendChild(svg);
            }
            messageDiv.appendChild(avatarDiv);

            // Content
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');

            // Sender name (for received messages)
            if (!isSent) {
                const senderDiv = document.createElement('div');
                senderDiv.classList.add('message-sender');
                senderDiv.textContent = msg.sender_username || 'Unknown';
                contentDiv.appendChild(senderDiv);
            }

            // Message text
            if (msg.content) {
                const textDiv = document.createElement('div');
                textDiv.classList.add('message-text');
                textDiv.textContent = msg.content || msg.message;
                contentDiv.appendChild(textDiv);
            }

            // Image
            if (msg.image_data) {
                const imageDiv = document.createElement('img');
                imageDiv.classList.add('message-image');
                imageDiv.src = `data:image/png;base64,${msg.image_data}`;
                contentDiv.appendChild(imageDiv);
            }

            // Time
            const timeDiv = document.createElement('div');
            timeDiv.classList.add('message-time');
            timeDiv.textContent = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            contentDiv.appendChild(timeDiv);

            messageDiv.appendChild(contentDiv);

            // Add translation icon for received messages
            if (!isSent) {
                const translateIcon = document.createElement('i');
                translateIcon.classList.add('fas', 'fa-language', 'translate-icon');
                translateIcon.title = 'Перевести';
                messageDiv.appendChild(translateIcon);

                // Event listener for translation icon click
                translateIcon.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    console.log("✏️ Translation icon clicked, messageId:", msg.message_id);
                    try {
                        const translatedText = await translateText(msg.message_id, 'en', 'RU');
                        console.log("✏️ Translation received:", translatedText);
                        const translationDiv = document.createElement('div');
                        translationDiv.classList.add('message-text', 'translated');
                        translationDiv.textContent = translatedText;
                        translationDiv.style.backgroundColor = '#3e5c76';
                        translationDiv.style.marginTop = '5px';
                        translationDiv.style.padding = '5px';
                        translationDiv.style.borderRadius = '5px';
                        contentDiv.appendChild(translationDiv);
                        translationDiv.addEventListener('click', () => {
                            console.log("✏️ Translation div removed for messageId:", msg.message_id);
                            translationDiv.remove();
                        });
                    } catch (error) {
                        console.error("✏️ Translation error:", error);
                        alert(`Ошибка перевода: ${error}`);
                    }
                });
            }

            return messageDiv;
        }

        // Функция для проверки, нужно ли прокручивать вниз
        function scrollToBottomIfNeeded(messageList) {
            const isOverflowing = messageList.scrollHeight > messageList.clientHeight;
            if (isOverflowing) {
                messageList.scrollTop = messageList.scrollHeight;
            }
        }

        // Функция для отправки сообщения
        function sendMessage(roomId, message, imageData) {
            const socket = new WebSocket(`ws://localhost:8000/ws/send_message/${roomId}`);
            const messageList = document.getElementById('message-list');
            const tempMessageId = 'temp-' + Date.now();

            socket.onopen = function () {
                getToken().then(token => {
                    const payload = {
                        message: message,
                        image_data: imageData,
                        token: token
                    };
                    console.log("Отправка payload:", payload); // Отладка
                    socket.send(JSON.stringify(payload));

                    // Локально добавляем сообщение
                    const tempMessage = {
                        content: message,
                        image_data: imageData,
                        sender_id: userId,
                        timestamp: new Date().toISOString(),
                        message_id: tempMessageId
                    };
                    const messageDate = formatDate(tempMessage.timestamp);
                    if (lastDate !== messageDate) {
                        const divider = createDateDivider(messageDate);
                        messageList.appendChild(divider);
                        lastDate = messageDate;
                    }
                    const messageElement = createMessageElement(tempMessage, true);
                    messageList.appendChild(messageElement);
                    scrollToBottomIfNeeded(messageList);
                }).catch(error => {
                    alert(`Ошибка: ${error}`);
                });
            };

            socket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                console.log("Получен ответ от сервера:", data); // Отладка
                if (data.event === "message_sent") {
                    console.log("Сообщение отправлено:", data.message);
                    const tempMessageElement = messageList.querySelector(`[data-message-id="${tempMessageId}"]`);
                    if (tempMessageElement) {
                        tempMessageElement.setAttribute('data-message-id', data.message_id);
                        const textDiv = tempMessageElement.querySelector('.message-text');
                        if (textDiv && data.message) {
                            textDiv.textContent = data.message;
                        }
                        const imageDiv = tempMessageElement.querySelector('.message-image');
                        if (imageDiv && data.image_data) {
                            imageDiv.src = `data:image/png;base64,${data.image_data}`;
                        }
                        const timeDiv = tempMessageElement.querySelector('.message-time');
                        timeDiv.textContent = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    }
                    scrollToBottomIfNeeded(messageList);
                } else if (data.event === "error") {
                    alert(`Ошибка: ${data.message}`);
                }
            };

            socket.onclose = function () {
                console.log("WebSocket для отправки сообщения закрыт");
            };

            socket.onerror = function (error) {
                console.error("Ошибка WebSocket:", error);
                alert("Ошибка соединения!");
            };
        }

        // Функция для удаления сообщения
        function deleteMessage(roomId, messageId, token) {
            const socket = new WebSocket(`ws://localhost:8000/ws/delete_message/${roomId}/${messageId}`);
            socket.onopen = function () {
                socket.send(JSON.stringify({ token: token }));
            };
            socket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                if (data.event === "message_deleted") {
                    console.log("Сообщение удалено:", data.message_id);
                    const messageElement = document.querySelector(`[data-message-id="${data.message_id}"]`);
                    if (messageElement) {
                        messageElement.remove();
                    }
                } else if (data.event === "error") {
                    alert(`Ошибка: ${data.message}`);
                }
            };
            socket.onclose = function () {
                console.log("WebSocket для удаления сообщения закрыт");
            };
            socket.onerror = function (error) {
                console.error("Ошибка WebSocket:", error);
                alert("Ошибка соединения!");
            };
        }

        // Функция для очистки чата
        function clearChat(roomId, token) {
            const socket = new WebSocket(`ws://localhost:8000/ws/clear_chat/${roomId}`);
            socket.onopen = function () {
                socket.send(JSON.stringify({ token: token }));
            };
            socket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                if (data.event === "chat_cleared") {
                    const messageList = document.getElementById('message-list');
                    messageList.innerHTML = '<div class="loading">Чат очищен</div>';
                    lastDate = null;
                } else if (data.event === "error") {
                    alert(`Ошибка: ${data.message}`);
                }
            };
            socket.onclose = function () {
                console.log("WebSocket для очистки чата закрыт");
            };
            socket.onerror = function (error) {
                console.error("Ошибка WebSocket:", error);
                alert("Ошибка соединения!");
            };
        }

        // Обработчик отправки сообщения
        document.getElementById('send-icon').addEventListener('click', function () {
            const messageInput = document.getElementById('message-input');
            const contactItem = document.querySelector('.contact-item.selected');
            if (!contactItem) {
                alert("Выберите контакт или группу!");
                return;
            }
            const roomId = contactItem.getAttribute('data-room-id');
            const message = messageInput.value.trim();
            console.log("Отправка сообщения:", { roomId, message }); // Отладка
            if (!roomId) {
                alert("Ошибка: ID комнаты не найден!");
                return;
            }
            // Удаляем проверку на пустое сообщение, так как сервер уже проверяет
            getToken().then(token => {
                sendMessage(roomId, message, null);
                messageInput.value = ''; // Очищаем поле ввода
            }).catch(error => {
                alert(`Ошибка: ${error}`);
            });
        });

        // Обработчик меню и очистки чата
        const chatMenu = document.getElementById('chat-menu');
        const dropdownMenu = document.getElementById('dropdown-menu');
        chatMenu.addEventListener('click', function (e) {
            e.stopPropagation();
            dropdownMenu.classList.toggle('active');
        });
        document.getElementById('clear-chat').addEventListener('click', function () {
            const contactItem = document.querySelector('.contact-item.selected');
            if (!contactItem) {
                alert("Выберите чат для очистки!");
                return;
            }
            const roomId = contactItem.getAttribute('data-room-id');
            if (!roomId) {
                alert("Ошибка: ID комнаты не найден!");
                return;
            }
            if (confirm("Вы уверены, что хотите очистить чат?")) {
                getToken().then(token => {
                    clearChat(roomId, token);
                    dropdownMenu.classList.remove('active');
                }).catch(error => {
                    alert(`Ошибка: ${error}`);
                });
            }
        });
        document.addEventListener('click', function (e) {
            if (!dropdownMenu.contains(e.target) && !chatMenu.contains(e.target)) {
                dropdownMenu.classList.remove('active');
            }
        });

        // Обработчик контекстного меню сообщений
        const contextMenu = document.getElementById('message-context-menu');
        let currentMessageId = null;
        document.getElementById('message-list').addEventListener('contextmenu', function (e) {
            e.preventDefault();
            const messageElement = e.target.closest('.message');
            if (messageElement && messageElement.classList.contains('sent') && messageElement.getAttribute('data-sender-id') === userId) {
                currentMessageId = messageElement.getAttribute('data-message-id');
                if (currentMessageId.startsWith('temp-')) {
                    return; // Игнорируем временные сообщения
                }
                contextMenu.style.top = `${e.clientY}px`;
                contextMenu.style.left = `${e.clientX}px`;
                contextMenu.classList.add('active');
            }
        });
        document.getElementById('delete-message').addEventListener('click', function () {
            const contactItem = document.querySelector('.contact-item.selected');
            if (!contactItem) {
                alert("Выберите чат!");
                return;
            }
            const roomId = contactItem.getAttribute('data-room-id');
            if (!roomId) {
                alert("Ошибка: ID комнаты не найден!");
                return;
            }
            if (confirm("Вы уверены, что хотите удалить это сообщение?")) {
                getToken().then(token => {
                    deleteMessage(roomId, currentMessageId, token);
                    contextMenu.classList.remove('active');
                }).catch(error => {
                    alert(`Ошибка: ${error}`);
                });
            }
        });
        document.addEventListener('click', function (e) {
            if (!contextMenu.contains(e.target)) {
                contextMenu.classList.remove('active');
            }
        });

        input.addEventListener("input", () => {
            if (input.value.trim() !== "") {
                sendIcon.classList.add("active");
                micIcon.classList.remove("active");
            } else {
                sendIcon.classList.remove("active");
                micIcon.classList.add("active");
            }
        });
        micIcon.classList.add("active");

        // WebSocket для отслеживания онлайна
        const onlineUsers = new Set();
        let ws;
        if (userId) {
            ws = new WebSocket(`ws://localhost:8000/ws/online/${userId}`);
            ws.onopen = () => {
                console.log("Соединение установлено, пользователь в сети");
            };
            ws.onmessage = async function (event) {
                const data = JSON.parse(event.data);
                console.log("Получено сообщение: ", data);
                const urlParams = new URLSearchParams(window.location.search);
                const selectedContactId = urlParams.get('selected_contact_id');
                if (data.event === "online_users_list") {
                    onlineUsers.clear();
                    data.users.forEach(id => onlineUsers.add(String(id)));
                    await updateStatus(selectedContactId);
                }
                if (data.event === "user_online") {
                    onlineUsers.add(String(data.user_id));
                    await updateStatus(selectedContactId);
                }
                if (data.event === "user_offline") {
                    onlineUsers.delete(String(data.user_id));
                    await updateStatus(selectedContactId);
                }
            };
            ws.onclose = () => {
                console.log("Соединение закрыто");
            };
        } else {
            console.log("Ошибка: ID пользователя не найден");
        }

        async function updateStatus(selectedContactId) {
            if (selectedContactId) {
                const selectedContact = document.querySelector(`.contact-item[data-contact-id="${selectedContactId}"]`);
                const statusElement = document.getElementById('chat-status');
                if (selectedContact && statusElement) {
                    if (onlineUsers.has(selectedContactId)) {
                        statusElement.innerText = "в сети";
                    } else {
                        statusElement.innerText = "оффлайн";
                    }
                }
            }
        }

        // Загрузка сообщений и обработка WebSocket для чата
        async function loadMessages(roomId) {
            if (chatSocket) {
                chatSocket.close();
            }
            chatSocket = new WebSocket(`ws://localhost:8000/ws/chat/${roomId}`);
            const messageList = document.getElementById('message-list');
            chatSocket.onopen = function () {
                console.log("WebSocket для чата открыт:", roomId);
                getToken().then(token => {
                    chatSocket.send(JSON.stringify({ token: token }));
                }).catch(error => {
                    console.error("Ошибка получения токена:", error);
                });
            };
            chatSocket.onmessage = function (event) {
            const data = JSON.parse(event.data);
            if (data.event === "message_history") {
                messageList.innerHTML = '';
                lastDate = null;
                // Сортируем сообщения по timestamp для надежности
                data.messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                data.messages.forEach(msg => {
                    const isSent = String(msg.sender_id) === String(userId);
                    const messageDate = formatDate(msg.timestamp);
                    if (lastDate !== messageDate) {
                        const divider = createDateDivider(messageDate);
                        messageList.appendChild(divider);
                        lastDate = messageDate;
                    }
                    const messageElement = createMessageElement(msg, isSent);
                    messageList.appendChild(messageElement);
                });
                scrollToBottomIfNeeded(messageList);
            } else if (data.event === "new_message") {
                if (String(data.sender_id) === String(userId) && messageList.querySelector(`[data-message-id="${data.message_id}"]`)) {
                    return;
                }
                const isSent = String(data.sender_id) === String(userId);
                const messageDate = formatDate(data.timestamp);
                if (lastDate !== messageDate) {
                    const divider = createDateDivider(messageDate);
                    messageList.appendChild(divider);
                    lastDate = messageDate;
                }
                const messageElement = createMessageElement(data, isSent);
                messageList.appendChild(messageElement);
                scrollToBottomIfNeeded(messageList);
            } else if (data.event === "message_edited") {
                const messageElement = messageList.querySelector(`[data-message-id="${data.message_id}"]`);
                if (messageElement) {
                    const textDiv = messageElement.querySelector('.message-text');
                    if (textDiv) {
                        textDiv.textContent = data.new_content + (data.edited ? " (ред.)" : "");
                    }
                    const timeDiv = messageElement.querySelector('.message-time');
                    if (timeDiv) {
                        timeDiv.textContent = new Date(data.timestamp).toLocaleTimeString([], {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    console.log("✏️ UI updated for edited messageId:", data.message_id);
                } else {
                    console.error("✏️ Edited message element not found for messageId:", data.message_id);
                }
            } else if (data.event === "message_deleted") {
                const messageElement = messageList.querySelector(`[data-message-id="${data.message_id}"]`);
                if (messageElement) {
                    messageElement.remove();
                }
            } else if (data.event === "chat_cleared") {
                messageList.innerHTML = '<div class="loading">Чат очищен</div>';
                lastDate = null;
            } else if (data.event === "error") {
                messageList.innerHTML = `<div class="error">${data.message}</div>`;
            }
        };

        chatSocket.onclose = function () {
            console.log("WebSocket для чата закрыт");
        };

        chatSocket.onerror = function (error) {
            console.error("Ошибка WebSocket для чата:", error);
            messageList.innerHTML = '<div class="error">Ошибка загрузки сообщений</div>';
        };
        };

        // Обработчики событий для контактов
        document.addEventListener('DOMContentLoaded', async function () {
            emojiButton.addEventListener('click', (e) => {
                e.stopPropagation();
                emojiPopup.classList.toggle('hidden');
                mediaPopup.classList.add('hidden');
            });

            document.querySelectorAll('.emoji').forEach(emoji => {
                emoji.addEventListener('click', (e) => {
                    e.stopPropagation();
                    input.value += emoji.textContent;
                    emojiPopup.classList.add('hidden');
                    input.focus();
                    sendIcon.classList.add("active");
                    micIcon.classList.remove("active");
                });
            });

            const chatAreaCon = document.getElementById('chat-area-con');
            const chatArea = document.getElementById('chat-area');
            const chatTitle = document.getElementById('current-chat-title');
            const chatStatus = document.getElementById('chat-status');
            let selectedContact = null;
            const urlParams = new URLSearchParams(window.location.search);
            const selectedContactId = urlParams.get('selected_contact_id');
            if (selectedContactId) {
                selectedContact = document.querySelector(`.contact-item[data-contact-id="${selectedContactId}"]`);
                if (selectedContact) {
                    selectedContact.classList.add('selected');
                    await updateStatus(selectedContactId);
                    chatAreaCon.style.display = 'none';
                    chatArea.style.display = 'block';
                    const contactName = selectedContact.querySelector('.contact-name').textContent;
                    chatTitle.textContent = contactName;
                    currentRoomId = selectedContact.getAttribute('data-room-id');
                    if (currentRoomId) {
                        await loadMessages(currentRoomId);
                    }
                } else {
                    chatArea.style.display = 'none';
                }
            }
            const contactItems = document.querySelectorAll('.contact-item');
            contactItems.forEach(contactItem => {
                contactItem.addEventListener('click', async function () {
                    contactItems.forEach(item => item.classList.remove('selected'));
                    if (selectedContact === contactItem) return;
                    selectedContact = contactItem;
                    selectedContact.classList.add('selected');
                    chatAreaCon.style.display = 'none';
                    chatArea.style.display = 'block';
                    const contactName = contactItem.querySelector('.contact-name').textContent;
                    chatTitle.textContent = contactName;
                    const contactId = contactItem.getAttribute('data-contact-id');
                    const roomType = contactItem.getAttribute('data-room-type');
                    if (roomType === 'group') {
                        chatStatus.innerText = '';
                    } else if (contactId) {
                        const chatUrl = `/dash/?selected_contact_id=${contactId}`;
                        window.history.pushState({}, '', chatUrl);
                        await updateStatus(contactId);
                    }
                    currentRoomId = contactItem.getAttribute('data-room-id');
                    if (currentRoomId) {
                        await loadMessages(currentRoomId);
                    }
                });
            });
            if (!selectedContact) {
                chatArea.style.display = 'none';
            }
        });

        document.addEventListener('click', (e) => {
            if (!emojiPopup.contains(e.target) && !emojiButton.contains(e.target)) {
                emojiPopup.classList.add('hidden');
            }
        });





// Обработчик для выбора опции "Редактировать" в контекстном меню
document.getElementById('edit-message').addEventListener('click', function (e) {
    e.stopPropagation();
    console.log("✏️ Edit message option clicked");
    const contactItem = document.querySelector('.contact-item.selected');
    if (!contactItem) {
        console.error("✏️ No selected chat");
        alert("Выберите чат!");
        return;
    }
    const roomId = contactItem.getAttribute('data-room-id');
    if (!roomId) {
        console.error("✏️ Room ID not found");
        alert("Ошибка: ID комнаты не найден!");
        return;
    }

    const messageElement = document.querySelector(`[data-message-id="${currentMessageId}"]`);
    if (!messageElement) {
        console.error("✏️ Message element not found for messageId:", currentMessageId);
        alert("Сообщение не найдено!");
        return;
    }
    const textDiv = messageElement.querySelector('.message-text');
    if (!textDiv) {
        console.error("✏️ Message has no text content");
        alert("Сообщение не содержит текста для редактирования!");
        return;
    }

    console.log("✏️ Starting edit process for messageId:", currentMessageId, "roomId:", roomId);

    // Создаем контейнер для поля ввода и кнопок
    const editContainer = document.createElement('div');
    editContainer.style.display = 'flex';
    editContainer.style.alignItems = 'center';
    editContainer.style.gap = '5px';

    // Создаем поле ввода
    const currentText = textDiv.textContent.replace(" (ред.)", "");
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentText;
    input.classList.add('edit-input');
    input.style.width = '100%';
    input.style.padding = '5px';
    input.style.borderRadius = '5px';
    input.style.border = '1px solid #ccc';

    // Создаем кнопку "Сохранить"
    const saveButton = document.createElement('button');
    saveButton.textContent = 'Сохранить';
    saveButton.style.padding = '5px 10px';
    saveButton.style.borderRadius = '5px';
    saveButton.style.border = '1px solid #ccc';
    saveButton.style.background = '#4CAF50';
    saveButton.style.color = 'white';
    saveButton.style.cursor = 'pointer';

    // Создаем кнопку "Отмена"
    const cancelButton = document.createElement('button');
    cancelButton.textContent = 'Отмена';
    cancelButton.style.padding = '5px 10px';
    cancelButton.style.borderRadius = '5px';
    cancelButton.style.border = '1px solid #ccc';
    cancelButton.style.background = '#f44336';
    cancelButton.style.color = 'white';
    cancelButton.style.cursor = 'pointer';

    // Добавляем элементы в контейнер
    editContainer.appendChild(input);
    editContainer.appendChild(saveButton);
    editContainer.appendChild(cancelButton);

    // Заменяем текст на контейнер
    textDiv.replaceWith(editContainer);
    input.focus();

    // Функция для сохранения изменений
    const saveChanges = () => {
        const newText = input.value.trim();
        if (newText === '') {
            console.error("✏️ Empty message content");
            alert("Сообщение не может быть пустым!");
            return;
        }
        getToken().then(token => {
            console.log("✏️ Token received, sending edit request:", {
                roomId,
                messageId: currentMessageId,
                newText,
                token: token.substring(0, 10) + "..."
            });
            // Временное обновление UI для отправителя
            const messageElement = document.querySelector(`[data-message-id="${currentMessageId}"]`);
            if (messageElement && editContainer.parentElement) {
                const textDiv = document.createElement('div');
                textDiv.classList.add('message-text');
                textDiv.textContent = newText + "   (ред.)"; // Добавляем "(ред.)" для визуального обновления
                editContainer.replaceWith(textDiv);
                console.log("✏️ Temporary UI update for messageId:", currentMessageId);
            }
            editMessage(roomId, currentMessageId, newText, token, editContainer);
            contextMenu.classList.remove('active');
        }).catch(error => {
            console.error("✏️ Token error:", error);
            alert(`Ошибка: ${error}`);
        });
    };

    // Обработчик для Enter
    input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            console.log("✏️ Enter pressed, saving changes");
            saveChanges();
        } else if (e.key === 'Escape') {
            console.log("✏️ Edit cancelled via Escape");
            editContainer.replaceWith(textDiv);
        }
    });

    // Обработчик для кнопки "Сохранить"
    saveButton.addEventListener('click', function (e) {
        e.stopPropagation();
        console.log("✏️ Save button clicked, saving changes");
        saveChanges();
    });

    // Обработчик для кнопки "Отмена"
    cancelButton.addEventListener('click', function (e) {
        e.stopPropagation();
        console.log("✏️ Edit cancelled via Cancel button");
        editContainer.replaceWith(textDiv);
    });

    // Закрытие при клике вне контейнера
    setTimeout(() => {
        document.addEventListener('click', function closeEdit(e) {
            if (!editContainer.contains(e.target)) {
                console.log("✏️ Edit closed by clicking outside");
                editContainer.replaceWith(textDiv);
                document.removeEventListener('click', closeEdit);
            }
        });
    }, 0);
});

// Функция для отправки отредактированного сообщения
function editMessage(roomId, messageId, newText, token, editContainer) {
    console.log("✏️ Connecting to WebSocket for editing", { roomId, messageId, newText });
    const socket = new WebSocket(`ws://localhost:8000/ws/edit_message/${roomId}/${messageId}`);

    socket.onopen = function () {
        console.log("✏️ WebSocket opened for editing");
        socket.send(JSON.stringify({ token: token, new_content: newText }));
    };

    socket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        console.log("✏️ WebSocket message received:", data);
        if (data.event === "message_edited") {
            console.log("✏️ Message edited successfully:", data.message_id);
            const messageElement = document.querySelector(`[data-message-id="${data.message_id}"]`);
            if (messageElement) {
                const textDiv = document.createElement('div');
                textDiv.classList.add('message-text');
                textDiv.textContent = data.new_content + (data.edited ? " (ред.)" : "");
                if (editContainer && editContainer.parentElement) {
                    editContainer.replaceWith(textDiv);
                } else {
                    const oldTextDiv = messageElement.querySelector('.message-text');
                    if (oldTextDiv) {
                        oldTextDiv.replaceWith(textDiv);
                    }
                }
                const timeDiv = messageElement.querySelector('.message-time');
                timeDiv.textContent = new Date(data.timestamp).toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                console.log("✏️ UI updated for messageId:", data.message_id);
            } else {
                console.error("✏️ Message element not found for messageId:", data.message_id);
            }
        } else if (data.event === "error") {
            console.error("✏️ Server error:", data.message);
            alert(`Ошибка: ${data.message}`);
        }
    };

    socket.onclose = function () {
        console.log("✏️ WebSocket closed for editing");
    };

    socket.onerror = function (error) {
        console.error("✏️ WebSocket error:", error);
        alert("Ошибка соединения!");
    };
}
















        // Обработчик для перевода сообщения
document.getElementById('translate-message').addEventListener('click', async function (e) {
    e.stopPropagation();
    console.log("✏️ Translate message option clicked, messageId:", currentMessageId);
    const messageElement = document.querySelector(`[data-message-id="${currentMessageId}"]`);
    if (!messageElement) {
        console.error("✏️ Message element not found for messageId:", currentMessageId);
        alert("Сообщение не найдено!");
        return;
    }
    const textDiv = messageElement.querySelector('.message-text');
    if (!textDiv) {
        console.error("✏️ Message has no text content");
        alert("Сообщение не содержит текста для перевода!");
        return;
    }

    try {
        const translatedText = await translateText(currentMessageId, 'en', 'RU');
        console.log("✏️ Translation received:", translatedText);
        const translationDiv = document.createElement('div');
        translationDiv.classList.add('message-text', 'translated');
        translationDiv.textContent = translatedText;
        translationDiv.style.backgroundColor = '#3e5c76';
        translationDiv.style.marginTop = '5px';
        translationDiv.style.padding = '5px';
        translationDiv.style.borderRadius = '5px';
        textDiv.insertAdjacentElement('afterend', translationDiv);
        translationDiv.addEventListener('click', () => {
            console.log("✏️ Translation div removed for messageId:", currentMessageId);
            translationDiv.remove();
        });
        contextMenu.classList.remove('active');
    } catch (error) {
        console.error("✏️ Translation error:", error);
        alert(`Ошибка перевода: ${error}`);
    }
});

// Функция для вызова API перевода
async function translateText(messageId, sourceLang, targetLang) {
    console.log("✏️ Initiating translation for messageId:", messageId, "targetLang:", targetLang);
    return new Promise((resolve, reject) => {
        const socket = new WebSocket(`ws://localhost:8000/ws/translate_message/${messageId}`);
        socket.onopen = function () {
            console.log("✏️ WebSocket opened for translation");
            getToken().then(token => {
                socket.send(JSON.stringify({ token: token, target_lang: targetLang }));
                console.log("✏️ Translation request sent, token:", token.substring(0, 10) + "...");
            }).catch(error => {
                console.error("✏️ Token error:", error);
                reject(`Ошибка получения токена: ${error}`);
            });
        };
        socket.onmessage = function (event) {
            const data = JSON.parse(event.data);
            console.log("✏️ WebSocket message received:", data);
            if (data.event === "message_translated") {
                resolve(data.translated_text);
            } else if (data.event === "error") {
                reject(`Ошибка: ${data.message}`);
            }
            socket.close();
        };
        socket.onerror = function (error) {
            console.error("✏️ WebSocket error:", error);
            reject(`Ошибка WebSocket: ${error}`);
            socket.close();
        };
        socket.onclose = function () {
            console.log("✏️ WebSocket closed for translation");
        };
    });
}
        
     // Update the context menu handler to allow translation for all messages
    document.getElementById('message-list').addEventListener('contextmenu', function (e) {
        e.preventDefault();
        const messageElement = e.target.closest('.message acclaim: .message');
        if (messageElement) {
            currentMessageId = messageElement.getAttribute('data-message-id');
            if (currentMessageId.startsWith('temp-')) {
                return; // Ignore temporary messages
            }
            const isSent = messageElement.classList.contains('sent') && messageElement.getAttribute('data-sender-id') === userId;
            const contextMenu = document.getElementById('message-context-menu');
            const deleteItem = document.getElementById('delete-message');
            const editItem = document.getElementById('edit-message');
            const translateItem = document.getElementById('translate-message');

            // Show/hide menu items based on whether the message is sent or received
            deleteItem.style.display = isSent ? 'block' : 'none';
            editItem.style.display = isSent ? 'block' : 'none';
            translateItem.style.display = 'block'; // Always show translate option

            contextMenu.style.top = `${e.clientY}px`;
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.classList.add('active');
        }
    });   














    </script>
</body>

</html>